<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TM Local Model Test</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { padding:40px; }
    #webcam-container canvas { border-radius:8px; }
    #label-container { margin-top:12px; white-space:pre-line; }
    .note { margin-top:8px; color:var(--text-color); }
  </style>
</head>
<body>
  <h2>Teachable Machine Local Model Test (강아지 vs 고양이)</h2>
  <div class="note">모델 폴더(`my_model/`)를 `tm_local_test.html`과 동일한 위치에 넣고 사용하세요.</div>
  <div style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <div>모델 URL 또는 로컬 폴더 선택</div>
    <input id="modelInput" type="text" placeholder="https://teachablemachine.withgoogle.com/models/[ID]/ (선택)" style="width:420px; padding:6px; border-radius:6px; border:1px solid #ccc;">
    <button id="btnLoadUrl" type="button">Load Model URL</button>
    <label style="display:inline-block; padding:6px 10px; background:#eee; border-radius:6px; cursor:pointer;"><input id="localModelPicker" type="file" webkitdirectory directory multiple style="display:none;"> 로컬 모델 폴더 선택</label>
    <button id="btnStart" type="button">Start Webcam</button>
    <button id="btnStop" type="button">Stop Webcam</button>
  </div>

  <div id="webcam-container"></div>
  <div id="label-container"></div>
  <div style="margin-top:12px;">
    <input id="imageUpload" type="file" accept="image/*">
    <div id="uploadPreview" style="margin-top:8px;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <script type="text/javascript">
    // variables
    let model, webcam, labelContainer, maxPredictions;
    let modelBaseURL = './my_model/'; // default local path

    async function loadModelFromURL(url){
      const modelURL = url + (url.endsWith('/')? 'model.json':'/model.json');
      const metadataURL = url + (url.endsWith('/')? 'metadata.json':'/metadata.json');
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
      labelContainer = document.getElementById('label-container');
      labelContainer.innerHTML = '';
      for (let i = 0; i < maxPredictions; i++) labelContainer.appendChild(document.createElement('div'));
      document.getElementById('uploadPreview').innerText = '모델 로드 완료. 웹캠 또는 이미지 업로드로 테스트하세요.';
    }

    // fallback: load default local model
    async function loadDefaultModel(){
      try{ await loadModelFromURL(modelBaseURL); }catch(e){ console.error(e); alert('로컬 모델 로드 실패. 모델 폴더가 맞는지 확인하세요.'); }
    }

    // Start webcam
    async function startWebcam(){
      if(!model){ alert('먼저 모델을 로드하세요 (URL 또는 로컬 모델).'); return; }
      if(webcam && webcam.playing) return;
      const flip = true;
      webcam = new tmImage.Webcam(320, 240, flip);
      await webcam.setup(); await webcam.play();
      document.getElementById('webcam-container').innerHTML='';
      document.getElementById('webcam-container').appendChild(webcam.canvas);
      requestAnimationFrame(camLoop);
    }

    function stopWebcam(){ if(webcam){ webcam.stop(); document.getElementById('webcam-container').innerHTML=''; }}

    async function camLoop(){ if(!webcam) return; webcam.update(); await predictFromCanvas(webcam.canvas); requestAnimationFrame(camLoop); }

    async function predictFromCanvas(canvas){ if(!model) return; const prediction = await model.predict(canvas); prediction.sort((a,b)=>b.probability-a.probability); const out = prediction.map(p=>`${p.className}: ${(p.probability*100).toFixed(1)}%`).join('\n'); document.getElementById('label-container').textContent = out; return prediction; }

    // image upload prediction
    document.getElementById('imageUpload').addEventListener('change', async (ev)=>{
      const file = ev.target.files[0]; if(!file) return;
      const img = new Image(); const url = URL.createObjectURL(file);
      img.onload = async ()=>{
        const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0);
        document.getElementById('uploadPreview').innerHTML = ''; document.getElementById('uploadPreview').appendChild(img);
        await predictFromCanvas(canvas);
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    // UI bindings
    document.getElementById('btnLoadUrl').addEventListener('click', async ()=>{
      const val = document.getElementById('modelInput').value.trim();
      if(!val) return alert('모델 URL을 입력하세요 (또는 로컬 모델 사용).');
      try{ await loadModelFromURL(val); }catch(err){ console.error(err); alert('모델 로드 실패: '+err.message); }
    });

    document.getElementById('btnStart').addEventListener('click', ()=>{ startWebcam().catch(e=>console.error(e)); });
    document.getElementById('btnStop').addEventListener('click', ()=>{ stopWebcam(); });

    // local folder picker: not reliable in browsers to load via file list; show instruction
    document.getElementById('localModelPicker').addEventListener('change', (e)=>{
      document.getElementById('uploadPreview').innerText = '브라우저는 폴더 선택으로 자동 로드할 수 없습니다. my_model 폴더를 tm_local_test.html과 동일 위치에 복사하세요.';
    });

    // Try default local model at load (non-blocking)
    (async ()=>{ try{ await loadDefaultModel(); }catch(e){ /* ignore */ } })();
  </script>
</body>
</html>